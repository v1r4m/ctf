from Crypto.Util.number import long_to_bytes, inverse
from Crypto.Cipher import AES
import math

N = 10347242542600406308094534195263088635791365996714020803160250407603636995099715433829129670160192589093770515128152510439089971458386641765448309859819378023880272965050178277879093516918807566027042642100169240017844173793930784667163759562215010481356537422986546632994001754291723194969521748076910835396937977810627980887157551885113202531423733595088875369751631232226097581969479909313254958049277471499732135617616297332871531530596176518111563310557213028740425533103112982126293232786326119238512934754974514742881890899165547139605333761970683944591937361699420431036603767467012489183290578309164784178633
e = 3311986667073495779819661492647781665180928338729865042826968893121477288104028672415705332665972755867861711304085148957997662937288947383110908043717598599426017484422084809208910486092822909662298925085867663251659781025068175951771651187222278814345138470007111789992552003468482347964267103806504197977364231330649526292875722283219443425291497285240653190201781346512871589039622122806771109809220085787813190940121150761761463256791250036396820146924876913040030532187290384737376868592733044732294197676117676820815598675412056870600146382869883717018539905436358459822165326225070894181935206514146099686162267119751019096873609300804816456005907
enc_ticket = 3946420937017846250393019311609396457338463614723557172414418971956390767261563151514428488890805225021688212721862533753952638354812535035364278722859438604041154655180097577414599710778354857775161040850623041785446044819204867397065653667589062151439260152909905577160138599029484856249429267771263679704326352858922042179435551285375575126876142413991900659195467217772357193174598528534725223102658732326697336473387891654610296170800740197748092566321210843941286260968460061251471684295914144882122101706465054524774059725005866235986370176677629767819073609117398726398647883974883695216900279944685266429904
enc_flag_bytes = b'`\x8d\x9e\x1e\xd4!\xf5\xe3\xf8,\xfb\x16UV\xcc\xae\xe6G\x91F\x06\x157)\x99|;\xb0\xf5\x87\xa2R\xa8\xd4H\xd16\xa6\xd6\xd1r\xe7 C\xd6i\x83\xb9\xf9\xf7f=\xab\x16'
nonce_bytes = b'\xf1\xdbF)\x91\xc5\xb4$'

k_candidate = (e // N) + 1

e_small = e % k_candidate

phi = (e - e_small) // k_candidate
print(f"Recovered phi: {phi}")

S = N + 1 - phi
print(f"Recovered S (p+q): {S}")

D = S**2 - 4*N

integer_sqrt_D = math.isqrt(D)

p = (S - integer_sqrt_D) // 2
q = (S + integer_sqrt_D) // 2

if p * q == N:
    
    d = inverse(e, phi)
    ticket = pow(enc_ticket, d, N)
    ticket_bytes = long_to_bytes(ticket)

    cipher = AES.new(ticket_bytes, AES.MODE_CTR, nonce=nonce_bytes)
    flag = cipher.decrypt(enc_flag_bytes)
    print(f"\nFLAG: {flag.decode(errors='ignore')}")